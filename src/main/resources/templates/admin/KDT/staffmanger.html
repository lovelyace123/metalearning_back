<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <title>매니저 등록</title>
    <style>
        .container {
            margin-top: 20px;
        }

        .card {
            border: 1px solid #ddd;
            padding: 20px;
            margin-bottom: 20px;
        }

        .card-header {
            font-weight: bold;
            background-color: #f8f9fa;
            padding: 10px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
        }

        .form-select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .btn {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
        }

        .btn:hover {
            background-color: #0056b3;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            border: 1px solid #ddd;
            text-align: left;
        }

        th {
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>

<!-- 세션 정보 출력 -->
<div class="card mb-4">
    <div class="card-header">
        <h3>세션 정보</h3>
    </div>
    <div class="card-body">
        <p><strong>세션 제목:</strong> <span th:text="${sessions.kdtSessionTitle}"></span></p>
        <p><strong>세션 설명:</strong> <span th:text="${sessions.kdtSessionDescript}"></span></p>
        <p><strong>시작일:</strong> <span th:text="${sessions.kdtSessionStartDate}"></span></p>
        <p><strong>종료일:</strong> <span th:text="${sessions.kdtSessionEndDate}"></span></p>
        <p><strong>시작시간:</strong> <span th:text="${sessions.kdtSessionStartTime}"></span></p>
        <p><strong>종료시간:</strong> <span th:text="${sessions.kdtSessionEndTime}"></span></p>
    </div>
</div>

<!-- 강사 등록 양식 -->
<h2>매니저 등록</h2>
<form th:action="@{/admin/KDT/{sessionId}/staff/manager(sessionId=${sessions.kdtSessionId})}" method="post">
    <!-- 세션 ID 히든 필드 추가 -->
    <input type="hidden" name="kdtSessionId" th:value="${sessions.kdtSessionId}" />

    <!-- 강사 선택 -->
    <div class="mb-3">
        <label for="manager" class="form-label">강사 선택</label>
        <table>
            <thead>
            <tr>
                <th>선택</th>
                <th>이름</th>
                <th>권한</th>
                <th>성별</th>
                <th>전화번호</th>
                <th>상태</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="user : ${usermanager}">
                <td><input type="checkbox" name="userIds" th:value="${user.userId}" /></td>
                <td th:text="${user.name}"></td>
                <td th:text="${user.userRole}"></td>
                <td th:text="${user.userGender}"></td>
                <td th:text="${user.userPhone}"></td>
                <td th:text="${user.userStatus}"></td>
            </tr>
            </tbody>
        </table>
    </div>

    <button type="submit" class="btn">강사 등록</button>
</form>

<!-- 이미 등록된 강사 리스트 -->
<h2>이미 등록된 매니저</h2>
<table>
    <thead>
    <tr>
        <th>이름</th>
        <th>권한</th>
        <th>성별</th>
        <th>전화번호</th>
        <th>삭제하기</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="registeredmanager : ${registeredmanagers}">
        <td th:text="${registeredmanager.name}"></td>
        <td th:text="${registeredmanager.userRole}"></td>
        <td th:text="${registeredmanager.userGender}"></td>
        <td th:text="${registeredmanager.userPhone}"></td>
        <td>
            <!-- 삭제 버튼 -->
            <button class="btn btn-danger btn-delete"
                    th:data-userId="${registeredmanager.userId}"
                    th:data-kdtSessionId="${sessions.kdtSessionId}">삭제</button>
        </td>
    </tr>
    </tbody>
</table>

<script>
    // CSRF 토큰을 헤더에 추가하기 위한 함수
    function getCsrfToken() {
      return document.querySelector('meta[name="_csrf"]').getAttribute('content');
    }

    function getCsrfHeaderName() {
      return document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
    }

    // 삭제 버튼 클릭 시 DELETE 요청
    document.querySelectorAll('.btn-delete').forEach(button => {
      button.addEventListener('click', async function() {
        const userId = this.getAttribute('data-userId');  // data-userId
        const kdtSessionId = this.getAttribute('data-kdtSessionId');  // data-kdtSessionId
        const csrfToken = getCsrfToken();
        const csrfHeaderName = getCsrfHeaderName();

        // 삭제 확인을 위한 confirm 창
        const isConfirmed = confirm("정말 이 매니저를를 삭제하시겠습니까?");
        if (!isConfirmed) {
          return; // 사용자가 취소를 클릭한 경우, 삭제 작업을 진행하지 않음
        }

        try {
          const response = await fetch(`/api/admin/KDT/session/${kdtSessionId}/staff/delete`, {
            method: 'DELETE', // DELETE 방식
            headers: {
              'Content-Type': 'application/json',
              [csrfHeaderName]: csrfToken  // CSRF 토큰을 헤더에 포함
            },
            body: JSON.stringify({ userId: userId, kdtSessionId: kdtSessionId })
          });

          const data = await response.json();

          if (data.status === 'success') {
            alert('매니저 배정이 취소되었습니다.'); // 서버에서 받은 success 메시지로 알림 표시
            // 삭제된 항목을 DOM에서 제거
            this.closest('tr').remove();
          } else {
            alert('삭제 실패: ' + data.message); // 서버에서 받은 fail 메시지로 알림 표시
          }
        } catch (error) {
          console.error('삭제 중 오류 발생:', error);
          alert('삭제 중 오류가 발생했습니다.'); // 삭제 중 오류 발생 시
        }
      });
    });
</script>

</body>
</html>
